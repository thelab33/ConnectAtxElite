<style>
  :root {
    --primary-yellow: #facc15;
    --primary-green: #4ade80;
    --bg-night: rgba(10, 10, 41, 0.92);
    --text-light: #fff;
  }
  [data-theme='dark'] {
    --bg-night: rgba(5, 5, 25, 0.97);
    --text-light: #eee;
  }

  .connect-goal {
    position: relative;
    overflow: hidden;
    border-radius: 1.5rem;
    background: var(--bg-night);
    padding: 2.5rem 1.25rem 2rem;
    text-align: center;
    color: var(--text-light);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.28);
    user-select: none;
    margin: 3rem auto;
    max-width: 480px;
    z-index: 10;
  }
  .connect-goal svg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }
  .connect-goal > *:not(svg) {
    position: relative;
    z-index: 2;
  }
  .connect-goal h2 {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--primary-yellow);
    text-shadow: 0 2px 8px #0008;
    margin-bottom: 0.5rem;
  }
  #goal-amount {
    font-size: 2.25rem;
    font-family: monospace;
    color: var(--primary-green);
    text-shadow: 0 2px 12px #0007;
    margin: 0.5rem 0;
    display: block;
  }
  progress#goal-bar {
    width: 100%;
    height: 1.2rem;
    border-radius: 0.6rem;
    background: #232333;
    appearance: none;
    box-shadow: 0 1px 8px #0005;
    margin: 1rem 0;
  }
  progress#goal-bar::-webkit-progress-bar {
    background: #232333;
    border-radius: 0.6rem;
  }
  progress#goal-bar::-webkit-progress-value {
    background: linear-gradient(
      90deg,
      var(--primary-yellow),
      var(--primary-green) 85%
    );
    box-shadow: 0 0 8px var(--primary-yellow);
    border-radius: 0.6rem;
    transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  progress#goal-bar::-moz-progress-bar {
    background: linear-gradient(
      90deg,
      var(--primary-yellow),
      var(--primary-green) 85%
    );
    box-shadow: 0 0 8px var(--primary-yellow);
    border-radius: 0.6rem;
    transition: width 1.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #donor-ticker {
    overflow: hidden;
    white-space: nowrap;
    mask-image: linear-gradient(
      to right,
      transparent,
      white 20%,
      white 80%,
      transparent
    );
    margin-top: 1.2rem;
    font-size: 1rem;
    font-style: italic;
    color: rgba(255, 255, 255, 0.85);
    position: relative;
    z-index: 2;
  }
  .ticker-content {
    display: inline-block;
    min-width: 200%;
    padding-right: 50%;
    animation: scrollTicker 20s linear infinite;
  }
  @keyframes scrollTicker {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }
</style>

<section
  id="goal"
  class="connect-goal"
  role="region"
  aria-labelledby="goal-heading"
  tabindex="-1"
  data-aos="fade-up"
  data-aos-delay="300"
>
  <!-- Circular Progress SVG -->
  <svg viewBox="0 0 200 200" aria-hidden="true" focusable="false">
    <defs>
      <linearGradient id="gauge-gradient" x1="1" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--primary-yellow)" />
        <stop offset="100%" stop-color="var(--primary-green)" />
      </linearGradient>
    </defs>
    <circle
      cx="100"
      cy="100"
      r="90"
      stroke="rgba(255,255,255,0.07)"
      stroke-width="20"
      fill="none"
    />
    <circle
      id="gauge-arc"
      cx="100"
      cy="100"
      r="90"
      stroke="url(#gauge-gradient)"
      stroke-width="20"
      stroke-dasharray="565.48"
      stroke-dashoffset="565.48"
      fill="none"
      transform="rotate(-90 100 100)"
    />
  </svg>

  <h2 id="goal-heading">Season Goal</h2>
  <span id="goal-amount" aria-live="polite" aria-atomic="true">
    $0 / ${{ goal }}
  </span>
  <progress
    id="goal-bar"
    max="{{ goal }}"
    aria-valuemin="0"
    aria-valuemax="{{ goal }}"
    aria-valuenow="0"
  ></progress>

  <div id="donor-ticker" aria-live="polite" aria-atomic="true">
    <div class="ticker-content">
      ðŸš¨ Latest donors: {{ latest_donors|join(', ') }} &nbsp; ðŸš¨ Latest donors:
      {{ latest_donors|join(', ') }}
    </div>
  </div>
</section>

<script>
  (() => {
    const total = {{ goal }};
    let current = {{ raised }};
    const arc = document.getElementById('gauge-arc');
    const bar = document.getElementById('goal-bar');
    const label = document.getElementById('goal-amount');
    const sec = document.getElementById('goal');

    function animateValue(el, start, end, dur=1400) {
      const range = end - start;
      const startTime = performance.now();
      function step(now) {
        const progress = Math.min((now - startTime) / dur, 1);
        const val = Math.floor(start + range * progress);
        el.textContent = `$${val.toLocaleString()} / $${total.toLocaleString()}`;
        if (progress < 1) requestAnimationFrame(step);
        else el.textContent = `$${end.toLocaleString()} / $${total.toLocaleString()}`;
      }
      requestAnimationFrame(step);
    }

    // Animate on view
    const observer = new IntersectionObserver((entries, obs) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          // Animate SVG Arc
          const offset = 565.48 * (1 - current / total);
          arc.style.transition = 'stroke-dashoffset 1.5s cubic-bezier(.7,.2,.2,1)';
          arc.style.strokeDashoffset = offset;

          // Animate progress bar
          bar.value = 0;
          setTimeout(() => bar.value = current, 60);

          // Animate number
          animateValue(label, 0, current);

          // Confetti for milestones
          [0.5, 0.75, 1].forEach(ratio => {
            if (current / total >= ratio) {
              import('https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/+esm')
                .then(({ default: confetti }) =>
                  confetti({ particleCount: 60, spread: 60, origin: { y: 0.6 }, colors: ['#facc15','#4ade80'] })
                );
            }
          });

          obs.disconnect();
        }
      });
    }, { threshold: 0.36 });
    observer.observe(sec);

    // Optional: Live updates (socket.io)
    if (window.io) {
      const socket = io();
      socket.on('donation_update', ({ total: newTotal }) => {
        current = newTotal;
        bar.value = newTotal;
        animateValue(label, 0, newTotal);
        arc.style.strokeDashoffset = 565.48 * (1 - newTotal / total);
      });
    }
  })();
</script>
